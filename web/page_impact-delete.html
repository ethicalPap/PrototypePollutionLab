<!DOCTYPE html>
<html>
<head>
    <title>Prototype Pollution Demo</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            background-color: #0078d7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f5f5f5;
        }
        .warning {
            color: red;
            font-weight: bold;
        }
        #parameterDisplay {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #fffbf0;
        }
    </style>
</head>
<body>
    <h1>Computer Control Panel</h1>
    <div class="warning">⚠️ Vulnerable to Prototype Pollution via URL Parameters</div>
    
    <div id="parameterDisplay">URL Parameters: None</div>
    
    <div style="margin-top: 20px;">
        <button id="powerButton">Power On</button>
        <button id="wifiButton">Connect WiFi</button>
    </div>
    
    <div id="status">System Status: Ready</div>
   
    <script>
        // Function to parse URL parameters - VULNERABLE to prototype pollution
        function parseQueryString(url) {
            const params = {};
            const queryString = url.split('?')[1] || '';
            const pairs = queryString.split('&');
            
            for (let i = 0; i < pairs.length; i++) {
                if (!pairs[i]) continue;
                
                const pair = pairs[i].split('=');
                const key = decodeURIComponent(pair[0]);
                const value = decodeURIComponent(pair[1] || '');
                
                // VULNERABLE: This is where prototype pollution can occur
                // It directly assigns to nested paths without checking
                setValueByPath(params, key, value);
            }
            
            return params;
        }
        
        // VULNERABLE: Recursive function that sets values by path
        function setValueByPath(obj, path, value) {
            // Handle values like __proto__.toString or constructor.prototype
            const parts = path.split('.');
            let current = obj;
            
            for (let i = 0; i < parts.length - 1; i++) {
                const key = parts[i];
                if (!current[key] || typeof current[key] !== 'object') {
                    current[key] = {};
                }
                current = current[key];
            }
            
            // Set the final property
            const lastKey = parts[parts.length - 1];
            
            // Try to interpret values like "true", "false", numbers, or JSON
            if (value === 'true') value = true;
            else if (value === 'false') value = false;
            else if (!isNaN(value)) value = Number(value);
            else {
                try {
                    // Attempt to parse as JSON if it looks like it
                    if ((value.startsWith('{') && value.endsWith('}')) || 
                        (value.startsWith('[') && value.endsWith(']'))) {
                        value = JSON.parse(value);
                    }
                } catch (e) {
                    // Keep as string if parsing fails
                }
            }
            
            current[lastKey] = value;
        }
        
        // Basic computer object
        const computer = {
            brand: "Lenovo",
            model: "ThinkPad T14",
            color: "Black",
            weight: "1.5kg/3.3lbs"
        };
        
        // Methods for computer object
        computer.powerOn = function() {
            console.log(`Powering on ${this.brand} ${this.model}`);
            document.getElementById('status').innerHTML =
                `System Status: Powered On - ${this.brand} ${this.model}`;
            this.powered = true;
            
            // VULNERABLE: Uses toString() which can be polluted
            if (this.onPowerOn) {
                this.onPowerOn.toString();
                eval(this.onPowerOn);
            }
        };
        
        computer.powerOff = function() {
            console.log(`Powering off ${this.brand} ${this.model}`);
            document.getElementById('status').textContent =
                `System Status: Powered Off - ${this.brand} ${this.model}`;
            this.powered = false;
        };
        
        computer.connectToWifi = function() {
            console.log(`Connecting ${this.brand} ${this.model} to WiFi`);
            document.getElementById('status').innerHTML =
                `System Status: Connected to WiFi - ${this.brand} ${this.model}`;
            this.wifiConnected = true;
            
            // VULNERABLE: Uses wifiCallback which can be polluted
            if (this.wifiCallback) {
                eval(this.wifiCallback);
            }
        };
        
        computer.disconnectFromWifi = function() {
            console.log(`Disconnecting ${this.brand} ${this.model} from WiFi`);
            document.getElementById('status').textContent =
                `System Status: Disconnected from WiFi - ${this.brand} ${this.model}`;
            this.wifiConnected = false;
        };
        
        // Parse URL parameters and apply them to the computer object
        const urlParams = parseQueryString(window.location.href);
        
        // Merge URL parameters into the computer object
        Object.assign(computer, urlParams);
        
        // Show parameters on the page
        const paramDisplay = document.getElementById('parameterDisplay');
        if (window.location.search) {
            paramDisplay.textContent = `URL Parameters: ${window.location.search}`;
        }
        
        // Event Listener for power button
        document.getElementById('powerButton').addEventListener('click', function() {
            if (!computer.powered) {
                computer.powerOn();
                this.textContent = "Power Off";
            } else {
                computer.powerOff();
                this.textContent = "Power On";
            }
        });
        
        // Event Listener for wifi button
        document.getElementById('wifiButton').addEventListener('click', function() {
            if (!computer.wifiConnected) {
                computer.connectToWifi();
                this.textContent = "Disconnect WiFi";
            } else {
                computer.disconnectFromWifi();
                this.textContent = "Connect WiFi";
            }
        });
        
        // Log computer object to console
        console.log("Computer object ready for testing in console:");
        console.log(computer);
        
        // Instructions for testing prototype pollution
        console.log("To test prototype pollution, try these example URLs:");
        console.log("1. ?onPowerOn=alert('XSS via onPowerOn')");
        console.log("2. ?wifiCallback=alert('XSS via wifiCallback')");
        console.log("3. ?__proto__.toString=alert('Prototype polluted!')");
    </script>
    
    <div style="margin-top: 30px; padding: 10px; border: 1px solid #ddd; background-color: #f0f8ff;">
        <h3>Test Prototype Pollution</h3>
        <p>Try these URL parameters:</p>
        <ul>
            <li><code>?onPowerOn=alert('XSS via onPowerOn')</code> - Triggers XSS when Power On is clicked</li>
            <li><code>?wifiCallback=alert('XSS via wifiCallback')</code> - Triggers XSS when Connect WiFi is clicked</li>
            <li><code>?__proto__.toString=alert('Prototype%20polluted!')</code> - Pollutes Object.prototype.toString</li>
            <li><code>?constructor.prototype.toString=alert('Global%20pollution!')</code> - More severe prototype pollution</li>
        </ul>
    </div>
</body>
</html>